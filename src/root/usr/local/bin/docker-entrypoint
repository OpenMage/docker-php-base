#!/usr/bin/env bash
set -e

HOST_DOMAIN="host.docker.internal"
ping -q -c1 $HOST_DOMAIN > /dev/null 2>&1
if [ $? -ne 0 ]; then
  HOST_IP=$(ip route | awk 'NR==1 {print $3}')
  echo -e "$HOST_IP\t$HOST_DOMAIN" >> /etc/hosts
fi

if [ -n "${PHP_EXT_ENABLE}" ]; then
  docker-php-ext-enable ${PHP_EXT_ENABLE}
fi

if [ "$1" = "/usr/local/bin/php" ] || [ "$1" = "php" ]; then
  exec gosu 33:33 "$@"
elif [ "$1" = "/usr/local/bin/composer" ] || [ "$1" = "composer" ]; then
  exec gosu 33:33 "$@"
elif [ "$1" = "/usr/local/bin/magerun" ] || [ "$1" = "magerun" ]; then
  exec gosu 33:33 "$@"
elif [ "$1" = "/usr/local/bin/magerun2" ] || [ "$1" = "magerun2" ]; then
  exec gosu 33:33 "$@"
elif [ "$1" = "/usr/local/sbin/php-fpm" ] || [ "$1" = "php-fpm" ]; then
    exec "$@"
elif  [ "$1" = "/usr/sbin/cron" ] || [ "$1" = "cron" ]; then
  if test -f "${CRONTAB_CONFIG}"; then
    echo "Adding crontab in ${CRONTAB_CONFIG}"
    /usr/bin/crontab "${CRONTAB_CONFIG}"
  fi
fi
exec "$@"